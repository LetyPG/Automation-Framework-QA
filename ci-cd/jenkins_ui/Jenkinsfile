// Jenkinsfile for UI/Selenium Tests - Smoke and Regression
// This pipeline runs browser-based tests using Selenium WebDriver

pipeline {
    agent {
        label 'linux'  // Use Linux agent with display capabilities
    }
    
    environment {
        // Python configuration
        PYTHON_VERSION = "3.10"
        
        // Application URLs
        BASE_URL = 'https://magento.softwaretestingboard.com'
        LOGIN_URL = "${BASE_URL}/customer/account/login/"
        
        // Browser settings
        BROWSER = 'chrome'
        HEADLESS = 'true'  // Run in headless mode for CI
        
        // Credentials (securely injected from Jenkins)
        TEST_USERNAME = credentials('test-user-username')
        TEST_PASSWORD = credentials('test-user-password')
    }
    
    options {
        // Keep only last 30 builds
        buildDiscarder(logRotator(
            numToKeepStr: '30',
            artifactNumToKeepStr: '10'
        ))
        
        // Timeout entire pipeline after 60 minutes
        timeout(time: 60, unit: 'MINUTES')
        
        // Disable concurrent builds
        disableConcurrentBuilds()
    }
    
    triggers {
        // Run smoke tests every 4 hours
        cron('H */4 * * *')
        
        // Check repository for changes every 15 minutes
        pollSCM('H/15 * * * *')
    }
    
    stages {
        stage('Checkout Code') {
            steps {
                echo ' Checking out code from repository...'
                checkout scm
                
                // Display commit information
                sh '''
                    echo "Current Branch: $(git branch --show-current)"
                    echo "Last Commit: $(git log -1 --oneline)"
                '''
            }
        }
        
        stage('Setup Environment') {
            steps {
                echo 'Setting up Python environment and dependencies...'
                sh """
                    # Create virtual environment
                    python${PYTHON_VERSION} -m venv venv
                    
                    # Activate and install dependencies
                    . venv/bin/activate
                    pip install --upgrade pip
                    pip install -r requiriments.txt
                    
                    # Verify installations
                    pip list
                    python --version
                """
            }
        }
        
        stage('Install Browser & Drivers') {
            steps {
                echo 'Installing Chrome browser and drivers...'
                sh """
                    # Update package list
                    sudo apt-get update
                    
                    # Install Chrome browser
                    wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
                    sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
                    sudo apt-get update
                    sudo apt-get install -y google-chrome-stable
                    
                    # Verify Chrome installation
                    google-chrome --version
                    
                    # ChromeDriver is managed by Selenium Manager (Selenium 4.6+)
                    # No manual installation needed
                """
            }
        }
        
        stage('Code Quality Check') {
            steps {
                echo 'Running code quality checks...'
                sh """
                    . venv/bin/activate
                    pip install flake8
                    
                    # Lint Python files (allow failures, only warn)
                    flake8 pages/ tests/smoke_tests/ utils/ \
                        --max-line-length=120 \
                        --exclude=venv,__pycache__,.pytest_cache \
                        || echo "Linting issues found (non-blocking)"
                """
            }
        }
        
        stage('Run Smoke Tests') {
            steps {
                echo ' Executing smoke tests...'
                sh """
                    . venv/bin/activate
                    
                    # Set display for headless execution
                    export DISPLAY=:99
                    
                    # Run smoke tests with pytest
                    pytest tests/smoke_tests/ -v -m smoke \
                        --html=reports/smoke_report.html \
                        --self-contained-html \
                        --alluredir=reports/allure-results \
                        --maxfail=5 \
                        || true
                """
            }
        }
        
        stage('Run Regression Tests') {
            when {
                // Only run regression on main branch or scheduled builds
                anyOf {
                    branch 'main'
                    triggeredBy 'TimerTrigger'
                }
            }
            steps {
                echo 'Executing regression test suite...'
                sh """
                    . venv/bin/activate
                    
                    export DISPLAY=:99
                    
                    # Run regression tests
                    pytest tests/regression_tests/ -m regression -v \
                        --html=reports/regression_report.html \
                        --self-contained-html \
                        --alluredir=reports/allure-results \
                        || true
                """
            }
        }
        
        stage('Run Unit Tests') {
            steps {
                echo ' Running unit tests for page objects...'
                sh """
                    . venv/bin/activate
                    
                    # Run unit tests (fast, no browser)
                    pytest tools/src_unit/ -v \
                        --html=reports/unit_report.html \
                        --self-contained-html \
                        || true
                """
            }
        }
        
        stage('Generate Allure Report') {
            steps {
                echo 'Generating Allure test report...'
                script {
                    allure includeProperties: false,
                           jdk: '',
                           results: [[path: 'reports/allure-results']]
                }
            }
        }
    }
    
    post {
        always {
            echo ' Publishing test reports and artifacts...'
            
            // Publish HTML reports
            publishHTML(target: [
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'reports',
                reportFiles: 'smoke_report.html',
                reportName: 'Smoke Test Report',
                reportTitles: 'UI Smoke Tests'
            ])
            
            publishHTML(target: [
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'reports',
                reportFiles: 'regression_report.html',
                reportName: 'Regression Test Report',
                reportTitles: 'UI Regression Tests'
            ])
            
            publishHTML(target: [
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'reports',
                reportFiles: 'unit_report.html',
                reportName: 'Unit Test Report',
                reportTitles: 'Page Object Unit Tests'
            ])
            
            // Archive all reports and screenshots
            archiveArtifacts artifacts: 'reports/**/*', allowEmptyArchive: true
            
            // Archive screenshots if tests captured any
            archiveArtifacts artifacts: 'screenshots/**/*.png', allowEmptyArchive: true
            
            // Clean workspace to save disk space
            echo 'ðŸ§¹ Cleaning up workspace...'
            cleanWs()
        }
        
        success {
            echo 'Pipeline completed successfully! All tests passed.'
            
            // Optional: Send success notification to Slack
            // slackSend(
            //     color: 'good',
            //     message: "UI Tests Passed: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
            // )
        }
        
        failure {
            echo ' Pipeline failed! Check test results for details.'
            
            // Send email notification
            emailext(
                subject: " UI Test Failure: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    <html>
                    <body>
                        <h2>UI Test Failure Report</h2>
                        <p><strong>Job:</strong> ${env.JOB_NAME}</p>
                        <p><strong>Build Number:</strong> ${env.BUILD_NUMBER}</p>
                        <p><strong>Build URL:</strong> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></p>
                        <p><strong>Branch:</strong> ${env.BRANCH_NAME}</p>
                        <p><strong>Status:</strong> <span style="color: red;">FAILED</span></p>
                        <br>
                        <p>Please check the test reports and console output for details.</p>
                        <p>View test reports: <a href="${env.BUILD_URL}Smoke_20Test_20Report/">Smoke Tests</a></p>
                    </body>
                    </html>
                """,
                to: 'qa-team@example.com',
                mimeType: 'text/html',
                attachLog: true
            )
            
            // Optional: Send Slack notification
            // slackSend(
            //     color: 'danger',
            //     message: "UI Tests Failed: ${env.JOB_NAME} #${env.BUILD_NUMBER}\nCheck: ${env.BUILD_URL}"
            // )
        }
        
        unstable {
            echo ' Build unstable - some tests failed but build succeeded.'
            
            emailext(
                subject: " UI Tests Unstable: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: "Some tests failed. Check: ${env.BUILD_URL}",
                to: 'qa-team@example.com'
            )
        }
        
        changed {
            echo ' Build status changed from previous build.'
            
            script {
                def previousResult = currentBuild.previousBuild?.result
                def currentResult = currentBuild.result
                
                emailext(
                    subject: "Status Changed: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                    body: "Build status changed from ${previousResult} to ${currentResult}\nURL: ${env.BUILD_URL}",
                    to: 'qa-team@example.com'
                )
            }
        }
    }
}
